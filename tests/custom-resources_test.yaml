suite: custom-resources

templates:
  - custom-resources.yaml

set:
  appName: "example-app"

tests:
  - it: should work with no inputs provided
    asserts:
      - hasDocuments:
          count: 0

  - it: should work with only a customResources list
    set:
      customResources:
        - |
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example
          spec:
            foo: bar
        - |
          apiVersion: v1
          kind: CustomThing2
          metadata:
            name: example2
          spec:
            foo: bar2
    asserts:
      - hasDocuments:
          count: 2
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing2
          name: example2
          any: true

  - it: should work with only customResourcesMap
    set:
      customResourcesMap:
        example3: |
          apiVersion: v1
          kind: CustomThing3
          metadata:
            name: example3
          spec:
            foo: bar3
        example4: |
          apiVersion: v1
          kind: CustomThing4
          metadata:
            name: example4
          spec:
            foo: bar4
    asserts:
      - hasDocuments:
          count: 2
      - containsDocument:
          apiVersion: v1
          kind: CustomThing3
          name: example3
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing4
          name: example4
          any: true

  - it: should work with both customResources and customResourcesMap
    set:
      customResources:
        - |
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example
          spec:
            foo: bar
        - |
          apiVersion: v1
          kind: CustomThing2
          metadata:
            name: example2
          spec:
            foo: bar2
      customResourcesMap:
        example3: |
          apiVersion: v1
          kind: CustomThing3
          metadata:
            name: example3
          spec:
            foo: bar3
        example4: |
          apiVersion: v1
          kind: CustomThing4
          metadata:
            name: example4
          spec:
            foo: bar4
    asserts:
      - hasDocuments:
          count: 4
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing2
          name: example2
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing3
          name: example3
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing4
          name: example4
          any: true

  - it: renders templated content
    set:
      foo: bar
      customResourcesMap:
        example: |
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example
          spec:
            foo: {{ .Values.foo }}
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.foo
          value: bar

  - it: handles empty templates without error
    set:
      customResources:
        - |
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example
          spec:
            foo: bar
        - ""
        - ""
        - |
          apiVersion: v1
          kind: CustomThing4
          metadata:
            name: example4
          spec:
            foo: bar4
    asserts:
      - hasDocuments:
          count: 2
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing4
          name: example4
          any: true

  - it: handles templates that render to nothing but whitespace without error
    set:
      customResources:
        - |
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example
          spec:
            foo: bar
        - "   "
        - "   "
        - |
          apiVersion: v1
          kind: CustomThing4
          metadata:
            name: example4
          spec:
            foo: bar4
    asserts:
      - hasDocuments:
          count: 2
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing4
          name: example4
          any: true

  - it: Can render multiple documents from the same template
    set:
      customResources:
        - |
          {{- range (list 1 2 3) }}
          ---
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example-{{ . }}
          spec:
            foo: bar
          {{- end }}
    asserts:
      - hasDocuments:
          count: 3
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-1
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-2
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-3
          any: true

  - it: can mix and match normal, multi-document, and empty templates safely
    set:
      customResources:
        - |
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example-1
        - ""
        - ""
        - |
          ---
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example-2
          ---
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example-3
      customResourcesMap:
        single: |
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example-4
        empty: ""
        multiple: |
          ---
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example-5
          ---
          apiVersion: v1
          kind: CustomThing
          metadata:
            name: example-6
    asserts:
      - hasDocuments:
          count: 6
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-1
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-2
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-3
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-4
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-5
          any: true
      - containsDocument:
          apiVersion: v1
          kind: CustomThing
          name: example-6
          any: true
